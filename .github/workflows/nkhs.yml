name: code

on:
  workflow_dispatch: 

jobs:
  clone_and_push:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.GH_TOKEN }}

      - name: Get latest go version
        id: version
        run: |
          echo ::set-output name=go_version::$(curl -s https://raw.githubusercontent.com/actions/go-versions/main/versions-manifest.json | grep -oE '"version": "[0-9]{1}.[0-9]{1,}(.[0-9]{1,})?"' | head -1 | cut -d':' -f2 | sed 's/ //g; s/"//g')
      
      - name: Setup Go
        uses: actions/setup-go@v3
        with:
          go-version: ${{ steps.version.outputs.go_version }}
          check-latest: true

      - name: code
        run: |
          #git clone -b sing-box-b-t https://github.com/White12352/sing-box.git sing-box
          #git clone -b dev https://github.com/White12352/sing.git sing
          git clone -b dev https://github.com/xchacha20-poly1305/husi.git husi
          rm -f husi/release.keystore
          mv -f .github/release.keystore husi
          rm -f husi/buildScript/lib/core.sh
          mv -f .github/core.sh husi/buildScript/lib/
          cd husi/libcore
          cp -f go.mod go.mod.bak
          cp -f go.sum go.sum.bak
          awk '1; END { print "replace github.com/sagernet/sing => ../../sing" }' go.mod > go.mod.tmp && mv -f go.mod.tmp go.mod
          awk '1; END { print "replace github.com/sagernet/sing-box => ../../sing-box" }' go.mod > go.mod.tmp && mv -f go.mod.tmp go.mod
          #go mod tidy
          cd ../buildScript/init/action
          sed -i -e 's|bash buildScript/lib/assets.sh|rm -f libcore/go.mod\nrm -f libcore/go.sum\nmv -f libcore/go.mod.bak libcore/go.mod\nmv -f libcore/go.sum.bak libcore/go.sum\n&|g' gradle.sh
          cd ../../../..
      
      - name: Commit and Push Changes
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          git config user.email "github-actions@github.com"
          git config user.name "GitHub Actions"
          git checkout -b dev2.1
          rm -rf .github
          rm -f README.md
          cp -r husi/* .
          cp -r husi/.github .
          rm -rf husi
          git add .
          git commit -m "commit"
          git push --force origin dev2.1
